name: Build XCFramework

on:
  workflow_dispatch:

jobs:
  build-xcframework:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Build .framework for iOS devices
      run: |
        BUILD_FOR_XCFRAMEWORK=true xcodebuild archive \
          -scheme AirwallexRisk \
          -sdk iphoneos \
          -destination 'generic/platform=iOS' \
          -archivePath './build/device.xcarchive' \
          SKIP_INSTALL=NO \
          BUILD_LIBRARY_FOR_DISTRIBUTION=YES
          
    - name: Debug device archive contents
      run: |
        echo "Contents of iOS devices archive:" \
        ls -R ./build/device.xcarchive \
        echo "Checking framework existence:" \
        ls -d ./build/device.xcarchive/Products/Library/Frameworks/AirwallexRisk.framework || echo "iOS devices framework not found!"

    - name: Build .framework for iOS simulator
      run: | 
        BUILD_FOR_XCFRAMEWORK=true xcodebuild archive \
          -scheme AirwallexRisk \
          -sdk iphonesimulator \
          -destination 'generic/platform=iOS Simulator' \
          -archivePath './build/simulator.xcarchive' \
          SKIP_INSTALL=NO \
          BUILD_LIBRARY_FOR_DISTRIBUTION=YES

    - name: Debug simulator archive contents
      run: |
        echo "Contents of iOS simulators archive:" \
        ls -R ./build/simulator.xcarchive \
        echo "Checking framework existence:" \
        ls -d ./build/simulator.xcarchive/Products/Library/Frameworks/AirwallexRisk.framework || echo "iOS simulators framework not found!"

    - name: List build directory
      run: ls -R ./build

    - name: Create XCFramework
      run: |
        xcodebuild -create-xcframework \
          -framework ./build/device.xcarchive/Products/Library/Frameworks/AirwallexRisk.framework \
          -framework ./build/simulator.xcarchive/Products/Library/Frameworks/AirwallexRisk.framework \
          -output ./build/AirwallexRisk.xcframework

    - name: Upload XCFramework
      uses: actions/upload-artifact@v4
      with:
        name: YourFramework.xcframework
        path: ./build/YourFramework.xcframework
        retention-days: 30
